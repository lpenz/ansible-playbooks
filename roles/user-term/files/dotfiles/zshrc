# lpenz .zshrc

DISABLE_AUTO_TITLE=true


# tramp (https://www.emacswiki.org/emacs/TrampMode#toc6)
if [[ "$TERM" == "dumb" ]]
then
    unsetopt zle
    unsetopt prompt_cr
    unsetopt prompt_subst
    unfunction precmd
    unfunction preexec
    PS1='$ '
    return
fi

if [ "$(ps -o ppid= $$ | xargs ps -o fname=)" = "xfce4-te" ]; then
    export LC_POWERLINE_FONTS=true
fi

if [ "$LC_POWERLINE_FONTS" = "true" ]; then
    # Enable nerdfont in xfce terminal only
    POWERLEVEL9K_MODE='nerdfont-complete'
fi

if [[ "$UID" -eq 0 ]]; then
    prompt_user_indicator() {
        "$1_prompt_segment" "$0" "$2" "$DEFAULT_COLOR" "yellow" "" 'ROOT_ICON'
    }
else
    prompt_user_indicator() {
        "$1_prompt_segment" "$0" "$2" "$DEFAULT_COLOR" "blue" "\uf295" ""
    }
fi
if [[ "$UID" -eq 0 || "$USER" = "lpenz" ]]; then
    POWERLEVEL9K_CONTEXT_TEMPLATE=%m
fi

POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(context user_indicator)
POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(vcs background_jobs dir)

source ~/.zgen-github/zgen.zsh
function zgen-config() {
    echo "Creating a zgen save"
    zgen oh-my-zsh
    # plugins
    zgen oh-my-zsh plugins/bgnotify
    zgen oh-my-zsh plugins/z
    zgen oh-my-zsh plugins/colored-man-pages
    zgen oh-my-zsh plugins/go
    zgen load zsh-users/zsh-completions
    zgen load zsh-users/zsh-syntax-highlighting
    zgen load zsh-users/zsh-history-substring-search
    # dircolors
    zgen load joel-porquet/zsh-dircolors-solarized
    zgen load bhilburn/powerlevel9k powerlevel9k
    # save all to init script
    zgen save
}
if ! zgen saved; then
    zgen-config
fi

zmodload zsh/terminfo
bindkey "$terminfo[kcuu1]" history-substring-search-up
bindkey "$terminfo[kcud1]" history-substring-search-down

setupsolarized dircolors.ansi-dark
# PROMPT='%(?,%{$fg[white]%},%{$fg[red]%}) %% '

# Custom configs:
WORDCHARS="*?_-.[]~=/&;!#$%^(){}<>"
setopt no_share_history
setopt clobber

# Hotkeys:
bindkey -M menuselect '^J' accept-and-infer-next-history
bindkey -M menuselect '^H' undo
bindkey -M menuselect '^K' vi-insert
bindkey "\ej" accept-and-menu-complete
bindkey "\el" copy-prev-shell-word
bindkey -s "\e[21~" "\033q\025mymake\012"
bindkey -s "\er" "\033q\025i=0; while ! read -t 1 && ! !!; do i=\$((i+1)); echo \"======== \$i \$(date)\";  done"

# env config
export VISUAL=vim
export EDITOR=vim
export ALTERNATE_EDITOR=/usr/bin/vim
export PAGER=

# aliases
alias rxvt-font-set="printf '\e]710;%s\007' "

# Load keychain
for f in "$HOME/.ssh/id_rsa" "$HOME/.ssh/id_dsa"; do
    if [ -e "$f" ]; then
        eval `keychain -q --eval --agents ssh $f`
    fi
done

ulimit -v 4000000

# Runs before executing a command
function lpenz_preexec {
    emulate -L zsh
    setopt extended_glob

    # cmd name only, or if this is sudo or ssh, the next cmd
    local CMD=${1[(wr)^(*=*|sudo|ssh|rake|-*)]:gs/%/%%}
    local LINE="${2:gs/%/%%}"

    title '$CMD' '%100>...>$LINE%<<'
}

# Runs after executing a command, before showing the prompt
function lpenz_precmd {
    title "%m:%~" "%m:%~"

    if [ "$RETVAL" != 0 ] || (( _P9K_COMMAND_DURATION > 3 )); then
        if [ "$RETVAL" != 0 ]; then
            local color=red
        else
            local color=green
        fi
        print -nP "%K{$color}\x1b[38;2;0;0;0m\ue0b8%f %f%K{$color}"
        if [ "$RETVAL" != 0 ]; then
            print -nP "\ue685 $RETVAL"
        fi
        if (( _P9K_COMMAND_DURATION > 3 )); then
            local humanReadableDuration
            if (( _P9K_COMMAND_DURATION > 3600 )); then
                humanReadableDuration=$(TZ=GMT; strftime '%H:%M:%S' $(( int(rint(_P9K_COMMAND_DURATION)) )))
            elif (( _P9K_COMMAND_DURATION > 60 )); then
                humanReadableDuration=$(TZ=GMT; strftime '%M:%S' $(( int(rint(_P9K_COMMAND_DURATION)) )))
            else
                # If the command executed in seconds, print as float.
                # Convert to float
                if [[ "${POWERLEVEL9K_COMMAND_EXECUTION_TIME_PRECISION}" == "0" ]]; then
                    # If user does not want microseconds, then we need to convert
                    # the duration to an integer.
                    typeset -i humanReadableDuration
                else
                    typeset -F ${POWERLEVEL9K_COMMAND_EXECUTION_TIME_PRECISION} humanReadableDuration
                fi
                humanReadableDuration=$_P9K_COMMAND_DURATION
            fi
            print -nP " ${icons[EXECUTION_TIME_ICON]}  $humanReadableDuration"
        fi
        print -P " %K{$color}\x1b[38;2;0;0;0m\ue0ba "
    fi
}

preexec_functions+=(lpenz_preexec)
precmd_functions+=(lpenz_precmd)

# do not beep
setterm --blength 0 2>/dev/null 

# Local customizations
if test -r ~/.zshrc.local; then . ~/.zshrc.local; fi
